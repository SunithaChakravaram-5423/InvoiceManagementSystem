<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <link rel="stylesheet" href="editor.css">
  <title>Editor Dashboard</title>
  
</head>
<body>
  <header>
    <h1>InvoicePro ‚Äî Editor Dashboard</h1>
  </header>

  <div class="about">
    <p>Welcome, Editor! Here you can create, view, edit, and manage invoices efficiently.</p>
  </div>

  <div class="dashboard">
    <div class="btn-group">
      <button id="addInvoiceBtn">‚ûï Add Invoice</button>
      <button id="viewInvoicesBtn">üìÑ View Invoices</button>
    </div>

    <div id="invoiceTableContainer" class="hidden">
      <h2>All Invoices</h2>
      <div class="export-buttons">
        <button onclick="downloadPDF()">Download PDF</button>
        <button onclick="downloadExcel()">Download Excel</button>
      </div>

      <table id="invoiceTable">
        <thead>
          <tr>
            <th>ID</th>
            <th>Client Name</th>
            <th>Client Email</th>
            <th>Due Date</th>
            <th>Status</th>
            <th>Total Amount</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="invoiceTableBody"></tbody>
      </table>
    </div>
  </div>

  <footer>
    <p>&copy; 2025 InvoicePro. Built with üíô for editors.</p>
  </footer>

  <script>
    const token = localStorage.getItem('token');
    const viewBtn = document.getElementById('viewInvoicesBtn');
    const addBtn = document.getElementById('addInvoiceBtn');
    const tableContainer = document.getElementById('invoiceTableContainer');
    const tableBody = document.getElementById('invoiceTableBody');

    addBtn.addEventListener('click', () => {
      window.location.href = 'add-invoice.html';
    });

    viewBtn.addEventListener('click', async () => {
      tableContainer.classList.remove('hidden');
      tableBody.innerHTML = '';
      try {
        const res = await fetch('http://127.0.0.1:3000/api/invoices', {
          headers: {
            Authorization: `Bearer ${token}`
          }
        });
        const invoices = await res.json();

        if (!Array.isArray(invoices)) throw new Error('Invalid response');

        invoices.forEach(inv => {
          const row = document.createElement('tr');

          row.innerHTML = `
            <td>INV-${String(inv.id).padStart(3, '0')}</td>
            <td>${inv.client_name}</td>
            <td>${inv.client_email}</td>
            <td>${new Date(inv.due_date).toLocaleDateString('en-IN')}</td>
            <td>${inv.status}</td>
            <td>‚Çπ${inv.total_amount}</td>
            <td>
              <button class="action-btn edit-btn" onclick="editInvoice(${inv.id})">Edit</button>
              <button class="action-btn delete-btn" onclick="deleteInvoice(${inv.id})">Delete</button>
            </td>
          `;
          tableBody.appendChild(row);
        });
      } catch (err) {
        alert('‚ö†Ô∏è Unable to fetch invoices. Please check backend connection.');
      }
    });

    function editInvoice(id) {
      window.location.href = `edit-invoice.html?id=${id}`;
    }

    async function deleteInvoice(id) {
      if (confirm('Are you sure you want to delete this invoice?')) {
        try {
          const res = await fetch(`http://127.0.0.1:3000/api/invoices/${id}`, {
            method: 'DELETE',
            headers: {
              Authorization: `Bearer ${token}`
            }
          });
          const data = await res.json();
          if (data.message) {
            alert(data.message);
            document.getElementById('viewInvoicesBtn').click(); // Refresh
          } else {
            alert('Delete failed');
          }
        } catch (err) {
          alert('Error deleting invoice');
        }
      }
    }

    function downloadPDF() {
      const element = document.getElementById("invoiceTable");
      const opt = {
        margin: 0.5,
        filename: 'invoices.pdf',
        image: { type: 'jpeg', quality: 0.98 },
        html2canvas: { scale: 2 },
        jsPDF: { unit: 'in', format: 'a4', orientation: 'landscape' }
      };
      html2pdf().set(opt).from(element).save();
    }
    function downloadExcel() {
      const table = document.getElementById("invoiceTable");
      const wb = XLSX.utils.book_new();
      const ws = XLSX.utils.table_to_sheet(table);
      XLSX.utils.book_append_sheet(wb, ws, "Invoices");
      XLSX.writeFile(wb, "invoices.xlsx");
    }

  </script>
</body>
</html>
