<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <link rel="stylesheet" href="edit.css">
  <title>Edit Invoice</title>
  
</head>
<body>
  <div class="container">
    <h1>Edit Invoice</h1>
    <form id="invoiceForm">
      <label>Client Name</label>
      <input type="text" id="clientName" required />

      <label>Client Email</label>
      <input type="email" id="clientEmail" required />

      <label>Issue Date</label>
      <input type="date" id="issueDate" required />

      <label>Due Date</label>
      <input type="date" id="dueDate" required />

      <label>Status</label>
      <select id="status" required>
        <option value="Pending">Pending</option>
        <option value="Paid">Paid</option>
        <option value="Overdue">Overdue</option>
      </select>

      <div id="itemsContainer"></div>
      <button type="button" class="add-item" onclick="addItem()">+ Add Item</button>

      <div class="btn-group">
        <button type="submit" class="btn btn-save">Save Changes</button>
        <button type="button" class="btn btn-delete" onclick="deleteInvoice()">Delete Invoice</button>
        <button type="button" class="btn btn-cancel" onclick="history.back()">Cancel</button>
      </div>
    </form>
  </div>

  <script>
    const invoiceId = new URLSearchParams(window.location.search).get('id');
    const token = localStorage.getItem('token');

    const clientName = document.getElementById('clientName');
    const clientEmail = document.getElementById('clientEmail');
    const issueDate = document.getElementById('issueDate');
    const dueDate = document.getElementById('dueDate');
    const status = document.getElementById('status');
    const itemsContainer = document.getElementById('itemsContainer');

    function addItem(item = {}) {
      const itemRow = document.createElement('div');
      itemRow.className = 'item-row';
      itemRow.innerHTML = `
        <input type="text" placeholder="Description" value="${item.description || ''}" required />
        <input type="number" placeholder="Quantity" value="${item.quantity || 1}" required />
        <input type="number" step="0.01" placeholder="Unit Price" value="${item.unit_price || 0}" required />
      `;
      itemsContainer.appendChild(itemRow);
    }

    function populateInvoice(data) {
      clientName.value = data.client_name || '';
      clientEmail.value = data.client_email || '';
      issueDate.value = data.issue_date ? data.issue_date.slice(0, 10) : '';
      dueDate.value = data.due_date ? data.due_date.slice(0, 10) : '';
      status.value = data.status || 'Pending';

      if (data.items && Array.isArray(data.items)) {
        itemsContainer.innerHTML = '';
        data.items.forEach(item => addItem(item));
      } else {
        addItem(); // At least one
      }
    }

    async function fetchInvoice() {
      try {
        const res = await fetch(`http://localhost:3000/api/invoices/${invoiceId}`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });

        if (!res.ok) throw new Error(`Failed to fetch invoice. Status: ${res.status}`);
        const data = await res.json();
        populateInvoice(data);
      } catch (err) {
        console.error(err);
        alert('Unable to load invoice.');
        window.location.href = 'view-invoices.html';
      }
    }

    document.getElementById('invoiceForm').addEventListener('submit', async (e) => {
      e.preventDefault();

      const items = Array.from(itemsContainer.querySelectorAll('.item-row')).map(row => {
        const [desc, qty, price] = row.querySelectorAll('input');
        return {
          description: desc.value.trim(),
          quantity: Number(qty.value),
          unit_price: Number(price.value)
        };
      });

      const payload = {
        client_name: clientName.value.trim(),
        client_email: clientEmail.value.trim(),
        issue_date: issueDate.value,
        due_date: dueDate.value,
        status: status.value,
        items
      };

      try {
        const res = await fetch(`http://localhost:3000/api/invoices/${invoiceId}`, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify(payload)
        });

        if (!res.ok) {
          const errorText = await res.text();
          console.error('Error:', errorText);
          throw new Error('Failed to update invoice.');
        }

        alert('Invoice updated successfully!');
        window.location.href = 'view-invoices.html';
      } catch (err) {
        console.error(err);
        alert('Failed to update invoice.');
      }
    });

    async function deleteInvoice() {
      if (!confirm('Are you sure you want to delete this invoice?')) return;

      try {
        const res = await fetch(`http://localhost:3000/api/invoices/${invoiceId}`, {
          method: 'DELETE',
          headers: { 'Authorization': `Bearer ${token}` }
        });

        if (!res.ok) throw new Error('Failed to delete invoice.');

        alert('Invoice deleted.');
        window.location.href = 'view-invoices.html';
      } catch (err) {
        console.error(err);
        alert('Failed to delete invoice.');
      }
    }

    if (invoiceId && token) {
      fetchInvoice();
    } else {
      alert('Unauthorized or missing invoice ID.');
      window.location.href = 'login.html';
    }
  </script>
</body>
</html>
